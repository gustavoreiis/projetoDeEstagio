<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerenciar Presença — Demo</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* limita a altura do modal-body e ativa scroll interno */
    #modalPresenca .modal-body {
      max-height: 60vh;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Gerenciar Presença — Atividades</h3>
    <div>
      <button class="btn btn-primary me-2" id="btnNovaAtividade">+ Nova Atividade</button>
      <button class="btn btn-outline-secondary" id="btnExport">Exportar</button>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="card mb-4">
    <div class="card-body">
      <form id="formFiltros" class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Pesquisar participante / atividade</label>
          <input type="search" id="fPesquisa" class="form-control" placeholder="Nome do participante ou título da atividade">
        </div>

        <div class="col-auto">
          <label class="form-label">Data início</label>
          <input type="date" id="fDataInicio" class="form-control">
        </div>
        <div class="col-auto">
          <label class="form-label">Data fim</label>
          <input type="date" id="fDataFim" class="form-control">
        </div>

        <div class="col-md-2">
          <label class="form-label">Status</label>
          <select id="fStatus" class="form-select">
            <option value="">Todas</option>
            <option value="futura">Futuras</option>
            <option value="realizada">Realizadas</option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Tipo</label>
          <select id="fTipo" class="form-select">
            <option value="">Todos</option>
            <option value="formacao">Formação</option>
            <option value="encontro_semanal">Encontro semanal</option>
            <option value="retiro">Retiro</option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Grupo</label>
          <select id="fGrupo" class="form-select">
            <option value="">Todos</option>
            <option value="servos">Servos</option>
            <option value="participantes">Participantes</option>
            <option value="coordenadores">Coordenadores</option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Ministério</label>
          <select id="fMinisterio" class="form-select">
            <option value="">Todos</option>
            <option value="musica">Música</option>
            <option value="pregacao">Pregação</option>
            <option value="intercessao">Intercessão</option>
          </select>
        </div>

        <div class="col-12 d-flex gap-2 mt-2">
          <button type="button" id="btnAplicar" class="btn btn-primary">Aplicar filtros</button>
          <button type="button" id="btnLimpar" class="btn btn-outline-secondary">Limpar filtros</button>
        </div>
      </form>
    </div>
  </div>

  <!-- LISTA DE ATIVIDADES -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="tblAtividades">
          <thead class="table-light">
            <tr>
              <th>Título</th>
              <th>Data / Hora</th>
              <th>Local</th>
              <th>Tipo</th>
              <th>Grupo</th>
              <th>Ministério</th>
              <th>Status</th>
              <th class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody id="tbodyAtividades">
            <!-- preenchido via JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PRESENÇA -->
<div class="modal fade" id="modalPresenca" tabindex="-1" aria-labelledby="modalPresencaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalPresencaLabel">Registrar presença — <span id="presencaTitulo"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <small id="presencaInfo" class="text-muted"></small>
          <div class="d-flex gap-2">
            <button id="marcarTodos" class="btn btn-sm btn-outline-success">Marcar todos</button>
            <button id="limparTodos" class="btn btn-sm btn-outline-secondary">Limpar todos</button>
          </div>
        </div>

        <ul class="list-group" id="listaPresenca">
          <!-- items via JS -->
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="button" id="btnSalvarPresenca" class="btn btn-primary">Salvar presença</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --- Dados mock (substitua com fetch para seu backend) ---
  const activities = [
    { id: 1, title: 'Formação Bíblica', date: '2025-09-20', time: '19:30', local: 'Sala A', tipo: 'formacao', grupo: 'servos', ministerio: 'pregacao', status: 'futura' },
    { id: 2, title: 'Encontro Semanal', date: '2025-09-13', time: '20:00', local: 'Igreja', tipo: 'encontro_semanal', grupo: 'participantes', ministerio: 'musica', status: 'realizada' },
    { id: 3, title: 'Retiro de Fim de Semana', date: '2025-10-10', time: '08:00', local: 'Sede', tipo: 'retiro', grupo: 'servos', ministerio: 'intercessao', status: 'futura' },
  ];

  // mock: participantes por atividade
  const participantsByActivity = {
    1: [
      { id: 87, nome: 'Ana Silva', grupo: 'servos' },
      { id: 88, nome: 'Carlos Souza', grupo: 'servos' },
      { id: 89, nome: 'Mariana Rocha', grupo: 'participantes' }
    ],
    2: [
      { id: 90, nome: 'Pedro Lima', grupo: 'participantes' },
      { id: 91, nome: 'João Alves', grupo: 'participantes' }
    ],
    3: [
      { id: 92, nome: 'Luciana Costa', grupo: 'musica' },
      { id: 93, nome: 'Rafael Gomes', grupo: 'intercessao' }
    ]
  };

  // --- Helpers DOM ---
  const tbodyAtividades = document.getElementById('tbodyAtividades');
  const fPesquisa = document.getElementById('fPesquisa');
  const fDataInicio = document.getElementById('fDataInicio');
  const fDataFim = document.getElementById('fDataFim');
  const fStatus = document.getElementById('fStatus');
  const fTipo = document.getElementById('fTipo');
  const fGrupo = document.getElementById('fGrupo');
  const fMinisterio = document.getElementById('fMinisterio');
  const btnAplicar = document.getElementById('btnAplicar');
  const btnLimpar = document.getElementById('btnLimpar');

  // modal elements
  const modalPresencaEl = document.getElementById('modalPresenca');
  const modalPresenca = bootstrap.Modal.getOrCreateInstance(modalPresencaEl);
  const presencaTitulo = document.getElementById('presencaTitulo');
  const presencaInfo = document.getElementById('presencaInfo');
  const listaPresenca = document.getElementById('listaPresenca');
  const marcarTodosBtn = document.getElementById('marcarTodos');
  const limparTodosBtn = document.getElementById('limparTodos');
  const btnSalvarPresenca = document.getElementById('btnSalvarPresenca');

  let atividadeAtual = null;
  let estadoPresenca = {}; // { participantId: true/false }

  // render table
  function renderActivities(list) {
    tbodyAtividades.innerHTML = '';
    if (list.length === 0) {
      tbodyAtividades.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-muted">Nenhuma atividade encontrada.</td></tr>`;
      return;
    }

    list.forEach(a => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${a.title}</td>
        <td>${a.date} ${a.time}</td>
        <td>${a.local}</td>
        <td>${formatTipo(a.tipo)}</td>
        <td>${formatGrupo(a.grupo)}</td>
        <td>${formatMinisterio(a.ministerio)}</td>
        <td>${formatStatus(a.status)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary me-1" onclick="abrirPresenca(${a.id})">Registrar presença</button>
          <button class="btn btn-sm btn-outline-secondary me-1" onclick="editarAtividade(${a.id})">Editar</button>
          <button class="btn btn-sm btn-outline-danger" onclick="excluirAtividade(${a.id})">Excluir</button>
        </td>
      `;
      tbodyAtividades.appendChild(tr);
    });
  }

  function formatTipo(t) {
    const map = { formacao: 'Formação', encontro_semanal: 'Encontro semanal', retiro: 'Retiro' };
    return map[t] || t;
  }
  function formatGrupo(g) {
    const map = { servos: 'Servos', participantes: 'Participantes', coordenadores: 'Coordenadores' };
    return map[g] || g;
  }
  function formatMinisterio(m) {
    const map = { musica: 'Música', pregacao: 'Pregação', intercessao: 'Intercessão' };
    return map[m] || m;
  }
  function formatStatus(s) {
    return s === 'realizada' ? '<span class="badge bg-success">Realizada</span>' : '<span class="badge bg-info">Futura</span>';
  }

  // filter logic
  function aplicarFiltros() {
    const pesquisa = fPesquisa.value.trim().toLowerCase();
    const inicio = fDataInicio.value;
    const fim = fDataFim.value;
    const status = fStatus.value;
    const tipo = fTipo.value;
    const grupo = fGrupo.value;
    const ministerio = fMinisterio.value;

    const filtered = activities.filter(a => {
      if (status && a.status !== status) return false;
      if (tipo && a.tipo !== tipo) return false;
      if (grupo && a.grupo !== grupo) return false;
      if (ministerio && a.ministerio !== ministerio) return false;

      if (inicio && a.date < inicio) return false;
      if (fim && a.date > fim) return false;

      if (pesquisa) {
        const inTitle = a.title.toLowerCase().includes(pesquisa);
        // também pode pesquisar por participantes: se algum participante tiver o nome buscamos
        const participants = participantsByActivity[a.id] || [];
        const inParticipants = participants.some(p => p.nome.toLowerCase().includes(pesquisa));
        if (!inTitle && !inParticipants) return false;
      }

      return true;
    });

    renderActivities(filtered);
  }

  function limparFiltros() {
    fPesquisa.value = '';
    fDataInicio.value = '';
    fDataFim.value = '';
    fStatus.value = '';
    fTipo.value = '';
    fGrupo.value = '';
    fMinisterio.value = '';
    aplicarFiltros();
  }

  // abrir modal presença
  window.abrirPresenca = function (idAtividade) {
    atividadeAtual = activities.find(a => a.id === idAtividade);
    if (!atividadeAtual) return;

    presencaTitulo.textContent = atividadeAtual.title;
    presencaInfo.textContent = `${atividadeAtual.date} ${atividadeAtual.time} • ${atividadeAtual.local}`;

    // carregar participantes (substituir por fetch no backend)
    const participants = participantsByActivity[idAtividade] || [];

    // inicializa estadoPresenca com false
    estadoPresenca = {};
    participants.forEach(p => estadoPresenca[p.id] = false);

    // render lista
    listaPresenca.innerHTML = '';
    if (participants.length === 0) {
      listaPresenca.innerHTML = `<li class="list-group-item text-muted">Nenhum participante disponível para esta atividade.</li>`;
    } else {
      participants.forEach(p => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';

        const left = document.createElement('div');
        left.innerHTML = `<strong>${p.nome}</strong><br><small class="text-muted">${formatGrupo(p.grupo)}</small>`;

        const right = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input';
        checkbox.id = `p-${p.id}`;
        checkbox.onclick = () => estadoPresenca[p.id] = checkbox.checked;

        right.appendChild(checkbox);
        li.appendChild(left);
        li.appendChild(right);
        listaPresenca.appendChild(li);
      });
    }

    modalPresenca.show();
  };

  // marcar todos / limpar todos
  marcarTodosBtn.addEventListener('click', () => {
    document.querySelectorAll('#listaPresenca input[type="checkbox"]').forEach(cb => {
      cb.checked = true;
      const id = parseInt(cb.id.replace('p-', ''));
      estadoPresenca[id] = true;
    });
  });

  limparTodosBtn.addEventListener('click', () => {
    document.querySelectorAll('#listaPresenca input[type="checkbox"]').forEach(cb => {
      cb.checked = false;
      const id = parseInt(cb.id.replace('p-', ''));
      estadoPresenca[id] = false;
    });
  });

  // salvar presença (substituir por POST/PUT no backend)
  btnSalvarPresenca.addEventListener('click', async () => {
    // aqui você faria fetch para enviar estadoPresenca para o backend
    console.log('Salvando presença da atividade', atividadeAtual?.id, estadoPresenca);

    // simula espera e feedback
    btnSalvarPresenca.disabled = true;
    btnSalvarPresenca.textContent = 'Salvando...';
    setTimeout(() => {
      btnSalvarPresenca.disabled = false;
      btnSalvarPresenca.textContent = 'Salvar presença';
      modalPresenca.hide();
      // após salvar, atualize lista de atividades ou feedback
      aplicarFiltros();
    }, 700);
  });

  // editar e excluir (placeholders)
  window.editarAtividade = function (id) {
    alert('Editar atividade ' + id + ' (implemente o formulário de edição / modal).');
  };
  window.excluirAtividade = function (id) {
    if (!confirm('Deseja excluir essa atividade?')) return;
    // chamar backend para excluir e depois atualizar
    alert('Atividade ' + id + ' excluída (simulação).');
  };

  // eventos filtros
  btnAplicar.addEventListener('click', aplicarFiltros);
  btnLimpar.addEventListener('click', limparFiltros);
  fPesquisa.addEventListener('keyup', (e) => { if (e.key === 'Enter') aplicarFiltros(); });

  // render inicial
  renderActivities(activities);
</script>
</body>
</html>
